---
title: カラーピッカー（色選択）
description: HEX/RGB/HSL対応。プリセット色・スポイト機能。
tags: [color-picker, form, input, design-tools]
frameworks: [Vanilla, Any]
level: advanced
prompt_template: |
  目的: 高機能カラーピッカーの実装
  前提: Vanilla JS（任意のフレームワークに移植可）
  要件:
  - <input type="color">をベースに拡張
  - HEX/RGB/HSL表示と入力
  - カラーパレット（プリセット色）
  - スライダー（H/S/L個別調整）
  - 透明度（Alpha）対応
  - 最近使った色の履歴
  - カラーコード入力
  - スポイト機能（EyeDropper API）
  - コピーボタン
  - アクセシビリティ対応
  納品: コンポーネント+CSS+最小限のJS
---

import LiveDemo from '../../components/LiveDemo.astro';

<LiveDemo
  title="カラーピッカー - HEX/RGB/HSL対応"
  height="550px"
  html={`
<div class="color-picker">
  <div class="color-picker-header">
    <label class="color-picker-label">カラーピッカー</label>
  </div>

  <div class="color-picker-preview">
    <input type="color" id="color-input-native" class="color-input-native" value="#3b82f6" />
    <div class="color-preview"></div>
  </div>

  <div class="color-picker-content">
    <div class="slider-group">
      <label for="hue-slider">
        <span>色相 (H)</span>
        <span class="slider-value" id="hue-value">217</span>
      </label>
      <input type="range" id="hue-slider" class="color-slider hue-slider" min="0" max="360" value="217" />
    </div>

    <div class="slider-group">
      <label for="saturation-slider">
        <span>彩度 (S)</span>
        <span class="slider-value" id="saturation-value">91%</span>
      </label>
      <input type="range" id="saturation-slider" class="color-slider" min="0" max="100" value="91" />
    </div>

    <div class="slider-group">
      <label for="lightness-slider">
        <span>明度 (L)</span>
        <span class="slider-value" id="lightness-value">61%</span>
      </label>
      <input type="range" id="lightness-slider" class="color-slider" min="0" max="100" value="61" />
    </div>
  </div>

  <div class="color-picker-inputs">
    <div class="input-group">
      <label for="hex-input">HEX</label>
      <input type="text" id="hex-input" class="color-code-input" value="#3b82f6" maxlength="7" />
    </div>

    <div class="input-group">
      <label for="rgb-input">RGB</label>
      <input type="text" id="rgb-input" class="color-code-input" readonly />
    </div>

    <div class="input-group">
      <label for="hsl-input">HSL</label>
      <input type="text" id="hsl-input" class="color-code-input" readonly />
    </div>
  </div>
</div>
  `}
  css={`
.color-picker { width: 100%; max-width: 320px; background: #1f2a37; border: 1px solid #374151; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }

.color-picker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.color-picker-label { font-weight: 600; font-size: 1rem; color: #e5edf4; }

.color-picker-preview { position: relative; width: 100%; height: 120px; margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; background: linear-gradient(45deg, #374151 25%, transparent 25%), linear-gradient(-45deg, #374151 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #374151 75%), linear-gradient(-45deg, transparent 75%, #374151 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
.color-input-native { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
.color-preview { width: 100%; height: 100%; pointer-events: none; border-radius: 8px; }

.color-picker-content { margin-bottom: 1.5rem; }

.slider-group { margin-bottom: 1rem; }
.slider-group label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #e5edf4; }
.slider-value { color: #9ca3af; }
.color-slider { width: 100%; height: 8px; appearance: none; border-radius: 4px; outline: none; cursor: pointer; background: #374151; }
.color-slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: white; border: 2px solid #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }
.color-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: white; border: 2px solid #3b82f6; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }

.hue-slider { background: linear-gradient(to right, hsl(0, 100%, 50%), hsl(60, 100%, 50%), hsl(120, 100%, 50%), hsl(180, 100%, 50%), hsl(240, 100%, 50%), hsl(300, 100%, 50%), hsl(360, 100%, 50%)); }

.color-picker-inputs { display: flex; flex-direction: column; gap: 0.75rem; }
.input-group label { display: block; font-size: 0.75rem; font-weight: 600; color: #9ca3af; margin-bottom: 0.25rem; text-transform: uppercase; }
.color-code-input { width: 100%; padding: 0.5rem; border: 1px solid #374151; border-radius: 4px; font-size: 0.875rem; font-family: 'Courier New', monospace; background: #0c1218; color: #e5edf4; }
.color-code-input:focus { outline: 2px solid #3b82f6; border-color: #3b82f6; }
  `}
  js={`
(() => {
  const nativeInput = document.querySelector('.color-input-native');
  const preview = document.querySelector('.color-preview');
  const hueSlider = document.querySelector('#hue-slider');
  const satSlider = document.querySelector('#saturation-slider');
  const lightSlider = document.querySelector('#lightness-slider');
  const hexInput = document.querySelector('#hex-input');
  const rgbInput = document.querySelector('#rgb-input');
  const hslInput = document.querySelector('#hsl-input');

  let currentColor = { h: 217, s: 91, l: 61 };

  function hslToRgb(h, s, l) {
    s /= 100;
    l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
    return [Math.round(255 * f(0)), Math.round(255 * f(8)), Math.round(255 * f(4))];
  }

  function rgbToHex(r, g, b) {
    return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
  }

  function hexToRgb(hex) {
    const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
      h = s = 0;
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
        case g: h = ((b - r) / d + 2) / 6; break;
        case b: h = ((r - g) / d + 4) / 6; break;
      }
    }

    return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
  }

  function updateUI() {
    const [r, g, b] = hslToRgb(currentColor.h, currentColor.s, currentColor.l);
    const hex = rgbToHex(r, g, b);

    preview.style.backgroundColor = hex;
    nativeInput.value = hex;

    hueSlider.value = currentColor.h;
    satSlider.value = currentColor.s;
    lightSlider.value = currentColor.l;

    satSlider.style.background = \`linear-gradient(to right, hsl(\${currentColor.h}, 0%, \${currentColor.l}%), hsl(\${currentColor.h}, 100%, \${currentColor.l}%))\`;
    lightSlider.style.background = \`linear-gradient(to right, hsl(\${currentColor.h}, \${currentColor.s}%, 0%), hsl(\${currentColor.h}, \${currentColor.s}%, 50%), hsl(\${currentColor.h}, \${currentColor.s}%, 100%))\`;

    document.querySelector('#hue-value').textContent = currentColor.h;
    document.querySelector('#saturation-value').textContent = currentColor.s + '%';
    document.querySelector('#lightness-value').textContent = currentColor.l + '%';

    hexInput.value = hex;
    rgbInput.value = \`rgb(\${r}, \${g}, \${b})\`;
    hslInput.value = \`hsl(\${currentColor.h}, \${currentColor.s}%, \${currentColor.l}%)\`;
  }

  nativeInput.addEventListener('input', (e) => {
    const rgb = hexToRgb(e.target.value);
    if (rgb) {
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
      currentColor = hsl;
      updateUI();
    }
  });

  hueSlider.addEventListener('input', (e) => {
    currentColor.h = parseInt(e.target.value);
    updateUI();
  });

  satSlider.addEventListener('input', (e) => {
    currentColor.s = parseInt(e.target.value);
    updateUI();
  });

  lightSlider.addEventListener('input', (e) => {
    currentColor.l = parseInt(e.target.value);
    updateUI();
  });

  hexInput.addEventListener('input', (e) => {
    const value = e.target.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      const rgb = hexToRgb(value);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentColor = hsl;
        updateUI();
      }
    }
  });

  updateUI();
})();
  `}
/>

## 実装コード

**HTML**
```html
<div class="color-picker">
  <div class="color-picker-header">
    <label for="color-input-native" class="color-picker-label">
      Color Picker
    </label>
    <button
      type="button"
      class="color-picker-eyedropper"
      id="eyedropper-btn"
      aria-label="Pick color from screen"
      title="Use eyedropper tool"
    >
      <svg viewBox="0 0 24 24" width="16" height="16">
        <path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-2.83 2.83a1 1 0 000 1.41l2.34 2.34-9.9 9.9-1.41-1.41a1 1 0 00-1.41 0L1 21.09a1 1 0 000 1.41l1.41 1.41a1 1 0 001.41 0l2.74-2.74a1 1 0 000-1.41l-1.41-1.41 9.9-9.9 2.34 2.34a1 1 0 001.41 0l2.83-2.83a1 1 0 000-1.41z"/>
      </svg>
    </button>
  </div>

  <div class="color-picker-preview">
    <input
      type="color"
      id="color-input-native"
      class="color-input-native"
      value="#3498db"
      aria-label="Color value"
    />
    <div class="color-preview" aria-hidden="true"></div>
  </div>

  <div class="color-picker-tabs">
    <button type="button" class="tab-btn active" data-tab="sliders">Sliders</button>
    <button type="button" class="tab-btn" data-tab="palette">Palette</button>
    <button type="button" class="tab-btn" data-tab="recent">Recent</button>
  </div>

  <div class="color-picker-content">
    <!-- Sliders Tab -->
    <div class="tab-panel active" data-panel="sliders">
      <div class="slider-group">
        <label for="hue-slider">
          <span>Hue</span>
          <span class="slider-value" id="hue-value">210</span>
        </label>
        <input
          type="range"
          id="hue-slider"
          class="color-slider hue-slider"
          min="0"
          max="360"
          value="210"
          aria-valuemin="0"
          aria-valuemax="360"
          aria-valuenow="210"
        />
      </div>

      <div class="slider-group">
        <label for="saturation-slider">
          <span>Saturation</span>
          <span class="slider-value" id="saturation-value">66%</span>
        </label>
        <input
          type="range"
          id="saturation-slider"
          class="color-slider saturation-slider"
          min="0"
          max="100"
          value="66"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="66"
        />
      </div>

      <div class="slider-group">
        <label for="lightness-slider">
          <span>Lightness</span>
          <span class="slider-value" id="lightness-value">56%</span>
        </label>
        <input
          type="range"
          id="lightness-slider"
          class="color-slider lightness-slider"
          min="0"
          max="100"
          value="56"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="56"
        />
      </div>

      <div class="slider-group">
        <label for="alpha-slider">
          <span>Alpha</span>
          <span class="slider-value" id="alpha-value">100%</span>
        </label>
        <input
          type="range"
          id="alpha-slider"
          class="color-slider alpha-slider"
          min="0"
          max="100"
          value="100"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="100"
        />
      </div>
    </div>

    <!-- Palette Tab -->
    <div class="tab-panel" data-panel="palette">
      <div class="color-palette" role="group" aria-label="Preset colors">
        <!-- Preset colors will be generated by JS -->
      </div>
    </div>

    <!-- Recent Tab -->
    <div class="tab-panel" data-panel="recent">
      <div class="color-recent" role="group" aria-label="Recently used colors">
        <p class="empty-message">No recent colors</p>
      </div>
    </div>
  </div>

  <div class="color-picker-inputs">
    <div class="input-group">
      <label for="hex-input">HEX</label>
      <div class="input-wrapper">
        <input
          type="text"
          id="hex-input"
          class="color-code-input"
          value="#3498db"
          pattern="^#[0-9A-Fa-f]{6}$"
          maxlength="7"
          aria-label="Hexadecimal color code"
        />
        <button
          type="button"
          class="copy-btn"
          data-copy="hex"
          aria-label="Copy HEX code"
          title="Copy to clipboard"
        >
          <svg viewBox="0 0 24 24" width="16" height="16">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="input-group">
      <label for="rgb-input">RGB</label>
      <div class="input-wrapper">
        <input
          type="text"
          id="rgb-input"
          class="color-code-input"
          value="rgb(52, 152, 219)"
          readonly
          aria-label="RGB color code"
        />
        <button
          type="button"
          class="copy-btn"
          data-copy="rgb"
          aria-label="Copy RGB code"
          title="Copy to clipboard"
        >
          <svg viewBox="0 0 24 24" width="16" height="16">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="input-group">
      <label for="hsl-input">HSL</label>
      <div class="input-wrapper">
        <input
          type="text"
          id="hsl-input"
          class="color-code-input"
          value="hsl(210, 66%, 56%)"
          readonly
          aria-label="HSL color code"
        />
        <button
          type="button"
          class="copy-btn"
          data-copy="hsl"
          aria-label="Copy HSL code"
          title="Copy to clipboard"
        >
          <svg viewBox="0 0 24 24" width="16" height="16">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>
```

**CSS**
```css
.color-picker {
  width: 100%;
  max-width: 320px;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  font-family: system-ui, -apple-system, sans-serif;
}

/* Header */
.color-picker-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.color-picker-label {
  font-weight: 600;
  font-size: 1rem;
  color: #333;
}
.color-picker-eyedropper {
  padding: 0.5rem;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.color-picker-eyedropper:hover {
  background: #e8e8e8;
}
.color-picker-eyedropper:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}
.color-picker-eyedropper svg {
  fill: #333;
}

/* Preview */
.color-picker-preview {
  position: relative;
  width: 100%;
  height: 120px;
  margin-bottom: 1.5rem;
  border-radius: 8px;
  overflow: hidden;
  background:
    linear-gradient(45deg, #ccc 25%, transparent 25%),
    linear-gradient(-45deg, #ccc 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #ccc 75%),
    linear-gradient(-45deg, transparent 75%, #ccc 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}
.color-input-native {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}
.color-preview {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

/* Tabs */
.color-picker-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid #e0e0e0;
}
.tab-btn {
  flex: 1;
  padding: 0.5rem 1rem;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: #666;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.tab-btn:hover {
  color: #333;
  background: #f5f5f5;
}
.tab-btn.active {
  color: #0066cc;
  border-bottom-color: #0066cc;
}
.tab-btn:focus {
  outline: 2px solid #0066cc;
  outline-offset: -2px;
}

/* Panels */
.color-picker-content {
  position: relative;
  min-height: 200px;
  margin-bottom: 1.5rem;
}
.tab-panel {
  display: none;
}
.tab-panel.active {
  display: block;
}

/* Sliders */
.slider-group {
  margin-bottom: 1rem;
}
.slider-group label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #333;
}
.slider-value {
  color: #666;
}
.color-slider {
  width: 100%;
  height: 8px;
  appearance: none;
  border-radius: 4px;
  outline: none;
  cursor: pointer;
}
.color-slider:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}

/* Slider Thumbs */
.color-slider::-webkit-slider-thumb {
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  border: 2px solid #0066cc;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}
.color-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: white;
  border: 2px solid #0066cc;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Slider Backgrounds */
.hue-slider {
  background: linear-gradient(to right,
    hsl(0, 100%, 50%),
    hsl(60, 100%, 50%),
    hsl(120, 100%, 50%),
    hsl(180, 100%, 50%),
    hsl(240, 100%, 50%),
    hsl(300, 100%, 50%),
    hsl(360, 100%, 50%)
  );
}

/* Color Palette */
.color-palette {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.5rem;
}
.palette-color {
  aspect-ratio: 1;
  border: 2px solid transparent;
  border-radius: 4px;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
}
.palette-color:hover {
  transform: scale(1.1);
}
.palette-color:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}
.palette-color.selected {
  border-color: #0066cc;
  box-shadow: 0 0 0 2px white, 0 0 0 4px #0066cc;
}

/* Recent Colors */
.color-recent {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.5rem;
}
.recent-color {
  aspect-ratio: 1;
  border: 2px solid #e0e0e0;
  border-radius: 4px;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
}
.recent-color:hover {
  transform: scale(1.1);
  border-color: #0066cc;
}
.recent-color:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}
.empty-message {
  grid-column: 1 / -1;
  text-align: center;
  color: #999;
  padding: 2rem;
  font-size: 0.875rem;
}

/* Input Groups */
.color-picker-inputs {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.input-group label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: #666;
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.input-wrapper {
  display: flex;
  gap: 0.5rem;
}
.color-code-input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  font-size: 0.875rem;
  font-family: 'Courier New', monospace;
}
.color-code-input:focus {
  outline: 2px solid #0066cc;
  outline-offset: 0;
  border-color: #0066cc;
}
.color-code-input[aria-invalid="true"] {
  border-color: #d32f2f;
}

/* Copy Button */
.copy-btn {
  padding: 0.5rem;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.copy-btn:hover {
  background: #e8e8e8;
}
.copy-btn:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}
.copy-btn svg {
  stroke: #333;
  fill: none;
  stroke-width: 2;
}
.copy-btn.copied {
  background: #4caf50;
  border-color: #4caf50;
}
.copy-btn.copied svg {
  stroke: white;
}
```

**JS**
```js
(() => {
  const picker = document.querySelector('.color-picker');
  if (!picker) return;

  const nativeInput = picker.querySelector('.color-input-native');
  const preview = picker.querySelector('.color-preview');
  const hueSlider = picker.querySelector('#hue-slider');
  const satSlider = picker.querySelector('#saturation-slider');
  const lightSlider = picker.querySelector('#lightness-slider');
  const alphaSlider = picker.querySelector('#alpha-slider');
  const hexInput = picker.querySelector('#hex-input');
  const rgbInput = picker.querySelector('#rgb-input');
  const hslInput = picker.querySelector('#hsl-input');
  const eyedropperBtn = picker.querySelector('#eyedropper-btn');
  const tabBtns = picker.querySelectorAll('.tab-btn');
  const tabPanels = picker.querySelectorAll('.tab-panel');
  const paletteContainer = picker.querySelector('.color-palette');
  const recentContainer = picker.querySelector('.color-recent');

  let currentColor = { h: 210, s: 66, l: 56, a: 1 };
  let recentColors = [];
  const maxRecent = 12;

  // Preset colors
  const presetColors = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F',
    '#BB8FCE', '#85C1E2', '#F8B88B', '#FAD7A0', '#AED6F1', '#A9DFBF',
    '#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6', '#1ABC9C',
    '#34495E', '#95A5A6', '#D35400', '#C0392B', '#BDC3C7', '#7F8C8D'
  ];

  // Utility functions
  function hslToRgb(h, s, l) {
    s /= 100;
    l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
    return [
      Math.round(255 * f(0)),
      Math.round(255 * f(8)),
      Math.round(255 * f(4))
    ];
  }

  function rgbToHex(r, g, b) {
    return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
  }

  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  function rgbToHsl(r, g, b) {
    r /= 255;
    g /= 255;
    b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
      h = s = 0;
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
        case g: h = ((b - r) / d + 2) / 6; break;
        case b: h = ((r - g) / d + 4) / 6; break;
      }
    }

    return {
      h: Math.round(h * 360),
      s: Math.round(s * 100),
      l: Math.round(l * 100)
    };
  }

  function updateUI() {
    const [r, g, b] = hslToRgb(currentColor.h, currentColor.s, currentColor.l);
    const hex = rgbToHex(r, g, b);
    const rgba = `rgba(${r}, ${g}, ${b}, ${currentColor.a})`;
    const hsla = `hsla(${currentColor.h}, ${currentColor.s}%, ${currentColor.l}%, ${currentColor.a})`;

    // Update preview
    preview.style.backgroundColor = rgba;
    nativeInput.value = hex;

    // Update sliders
    hueSlider.value = currentColor.h;
    satSlider.value = currentColor.s;
    lightSlider.value = currentColor.l;
    alphaSlider.value = currentColor.a * 100;

    // Update slider backgrounds
    satSlider.style.background = `linear-gradient(to right, hsl(${currentColor.h}, 0%, ${currentColor.l}%), hsl(${currentColor.h}, 100%, ${currentColor.l}%))`;
    lightSlider.style.background = `linear-gradient(to right, hsl(${currentColor.h}, ${currentColor.s}%, 0%), hsl(${currentColor.h}, ${currentColor.s}%, 50%), hsl(${currentColor.h}, ${currentColor.s}%, 100%))`;
    alphaSlider.style.background = `linear-gradient(to right, transparent, hsl(${currentColor.h}, ${currentColor.s}%, ${currentColor.l}%))`;

    // Update values
    picker.querySelector('#hue-value').textContent = currentColor.h;
    picker.querySelector('#saturation-value').textContent = currentColor.s + '%';
    picker.querySelector('#lightness-value').textContent = currentColor.l + '%';
    picker.querySelector('#alpha-value').textContent = Math.round(currentColor.a * 100) + '%';

    // Update inputs
    hexInput.value = hex;
    rgbInput.value = currentColor.a < 1 ? rgba : `rgb(${r}, ${g}, ${b})`;
    hslInput.value = currentColor.a < 1 ? hsla : `hsl(${currentColor.h}, ${currentColor.s}%, ${currentColor.l}%)`;

    // Update ARIA
    hueSlider.setAttribute('aria-valuenow', currentColor.h);
    satSlider.setAttribute('aria-valuenow', currentColor.s);
    lightSlider.setAttribute('aria-valuenow', currentColor.l);
    alphaSlider.setAttribute('aria-valuenow', Math.round(currentColor.a * 100));
  }

  // Event listeners
  nativeInput.addEventListener('input', (e) => {
    const rgb = hexToRgb(e.target.value);
    if (rgb) {
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
      currentColor.h = hsl.h;
      currentColor.s = hsl.s;
      currentColor.l = hsl.l;
      updateUI();
    }
  });

  hueSlider.addEventListener('input', (e) => {
    currentColor.h = parseInt(e.target.value);
    updateUI();
  });

  satSlider.addEventListener('input', (e) => {
    currentColor.s = parseInt(e.target.value);
    updateUI();
  });

  lightSlider.addEventListener('input', (e) => {
    currentColor.l = parseInt(e.target.value);
    updateUI();
  });

  alphaSlider.addEventListener('input', (e) => {
    currentColor.a = parseInt(e.target.value) / 100;
    updateUI();
  });

  hexInput.addEventListener('input', (e) => {
    const value = e.target.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      const rgb = hexToRgb(value);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentColor.h = hsl.h;
        currentColor.s = hsl.s;
        currentColor.l = hsl.l;
        updateUI();
        addToRecent(value);
        hexInput.setAttribute('aria-invalid', 'false');
      }
    } else {
      hexInput.setAttribute('aria-invalid', 'true');
    }
  });

  // Tabs
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      picker.querySelector(`[data-panel="${tab}"]`).classList.add('active');
    });
  });

  // Generate palette
  presetColors.forEach(color => {
    const btn = document.createElement('button');
    btn.className = 'palette-color';
    btn.style.backgroundColor = color;
    btn.setAttribute('aria-label', `Select color ${color}`);
    btn.addEventListener('click', () => {
      const rgb = hexToRgb(color);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentColor.h = hsl.h;
        currentColor.s = hsl.s;
        currentColor.l = hsl.l;
        updateUI();
        addToRecent(color);
      }
    });
    paletteContainer.appendChild(btn);
  });

  // Recent colors
  function addToRecent(hex) {
    if (!recentColors.includes(hex)) {
      recentColors.unshift(hex);
      if (recentColors.length > maxRecent) {
        recentColors.pop();
      }
      renderRecent();
    }
  }

  function renderRecent() {
    recentContainer.innerHTML = '';
    if (recentColors.length === 0) {
      recentContainer.innerHTML = '<p class="empty-message">No recent colors</p>';
      return;
    }
    recentColors.forEach(color => {
      const btn = document.createElement('button');
      btn.className = 'recent-color';
      btn.style.backgroundColor = color;
      btn.setAttribute('aria-label', `Select recent color ${color}`);
      btn.addEventListener('click', () => {
        const rgb = hexToRgb(color);
        if (rgb) {
          const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
          currentColor.h = hsl.h;
          currentColor.s = hsl.s;
          currentColor.l = hsl.l;
          updateUI();
        }
      });
      recentContainer.appendChild(btn);
    });
  }

  // Copy buttons
  picker.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.dataset.copy;
      let text = '';
      if (type === 'hex') text = hexInput.value;
      if (type === 'rgb') text = rgbInput.value;
      if (type === 'hsl') text = hslInput.value;

      try {
        await navigator.clipboard.writeText(text);
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 1000);
      } catch (err) {
        console.error('Copy failed:', err);
      }
    });
  });

  // EyeDropper API
  if ('EyeDropper' in window) {
    eyedropperBtn.addEventListener('click', async () => {
      try {
        const eyeDropper = new EyeDropper();
        const result = await eyeDropper.open();
        const rgb = hexToRgb(result.sRGBHex);
        if (rgb) {
          const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
          currentColor.h = hsl.h;
          currentColor.s = hsl.s;
          currentColor.l = hsl.l;
          updateUI();
          addToRecent(result.sRGBHex);
        }
      } catch (err) {
        console.error('EyeDropper failed:', err);
      }
    });
  } else {
    eyedropperBtn.style.display = 'none';
  }

  // Initialize
  updateUI();
  renderRecent();
})();
```
