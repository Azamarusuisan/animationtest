---
title: 検索バー（オートコンプリート付き）
description: リアルタイム候補表示。キーボード操作・ハイライト対応。
tags: [search, autocomplete, ux, accessibility]
frameworks: [Vanilla, Any]
level: intermediate
prompt_template: |
  目的: アクセシブルな検索オートコンプリート機能の実装
  前提: Vanilla JS（任意のフレームワークに移植可）
  要件:
  - 入力時のデバウンス（300ms）
  - ↑↓キーで候補選択、Enterで確定
  - Escで候補閉じる
  - マッチ部分のハイライト表示
  - aria-autocomplete, aria-activedescendant対応
  - ローディング表示
  - 候補なし時のメッセージ
  - キャンセルボタン（×）
  - アクセシビリティ対応
  納品: コンポーネント+CSS+最小限のJS
---

import LiveDemo from '../../components/LiveDemo.astro';

<LiveDemo
  title="検索オートコンプリートのデモ"
  height="350px"
  html={`
<div class="search-autocomplete">
  <div class="search-input-wrapper">
    <input
      type="text"
      id="search"
      class="search-input"
      placeholder="フルーツを検索..."
      autocomplete="off"
      aria-autocomplete="list"
      aria-controls="suggestions"
      aria-expanded="false"
      role="combobox"
    />
    <button class="search-clear" aria-label="Clear search" hidden>×</button>
    <div class="search-spinner" hidden></div>
  </div>
  <ul id="suggestions" class="suggestions" role="listbox" hidden></ul>
</div>
  `}
  css={`
.search-autocomplete { position: relative; max-width: 400px; margin: 0 auto; }
.search-input-wrapper { position: relative; display: flex; align-items: center; }
.search-input {
  width: 100%; padding: .75rem 2.5rem .75rem 1rem;
  border: 2px solid #374151; border-radius: 8px; font-size: 1rem;
  background: #1f2a37; color: #e5edf4; transition: border-color .2s;
}
.search-input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1); }
.search-input::placeholder { color: #9ca3af; }
.search-clear {
  position: absolute; right: 2.5rem; background: none; border: none;
  font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: .25rem; line-height: 1;
}
.search-clear:hover { color: #e5edf4; }
.search-spinner {
  position: absolute; right: .75rem; width: 20px; height: 20px;
  border: 2px solid #374151; border-top: 2px solid #60a5fa;
  border-radius: 50%; animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.suggestions {
  position: absolute; top: calc(100% + 4px); left: 0; right: 0;
  background: #1f2a37; border: 1px solid #374151; border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3); max-height: 300px; overflow-y: auto;
  margin: 0; padding: 0; list-style: none; z-index: 100;
}
.suggestion {
  padding: .75rem 1rem; cursor: pointer; transition: background .15s;
  color: #e5edf4;
}
.suggestion:hover { background: #374151; }
.suggestion[aria-selected="true"] { background: #2563eb; }
.suggestion mark {
  background: #fbbf24; color: #111827; font-weight: 600; padding: 0;
}
.no-results { padding: 1rem; text-align: center; color: #9ca3af; font-style: italic; }
  `}
  js={`
const input = document.querySelector('.search-input');
const clearBtn = document.querySelector('.search-clear');
const spinner = document.querySelector('.search-spinner');
const suggestions = document.getElementById('suggestions');
let debounceTimer;
let activeIndex = -1;

const data = ['Apple', 'Banana', 'Orange', 'Mango', 'Strawberry', 'Pineapple', 'Grape', 'Watermelon', 'Peach', 'Cherry'];

async function search(query) {
  if (!query.trim()) {
    closeSuggestions();
    return;
  }
  showSpinner();
  await new Promise(res => setTimeout(res, 200));
  const results = data.filter(item => item.toLowerCase().includes(query.toLowerCase()));
  hideSpinner();
  displaySuggestions(results, query);
}

function displaySuggestions(results, query) {
  suggestions.innerHTML = '';
  activeIndex = -1;
  if (results.length === 0) {
    suggestions.innerHTML = '<li class="no-results">候補が見つかりません</li>';
    openSuggestions();
    return;
  }
  results.forEach((item, idx) => {
    const li = document.createElement('li');
    li.className = 'suggestion';
    li.setAttribute('role', 'option');
    li.setAttribute('id', \`suggestion-\${idx}\`);
    li.setAttribute('aria-selected', 'false');
    const regex = new RegExp(\`(\${query})\`, 'gi');
    li.innerHTML = item.replace(regex, '<mark>$1</mark>');
    li.addEventListener('click', () => selectSuggestion(item));
    suggestions.appendChild(li);
  });
  openSuggestions();
}

function openSuggestions() {
  suggestions.hidden = false;
  input.setAttribute('aria-expanded', 'true');
}

function closeSuggestions() {
  suggestions.hidden = true;
  input.setAttribute('aria-expanded', 'false');
  activeIndex = -1;
  input.removeAttribute('aria-activedescendant');
}

function selectSuggestion(value) {
  input.value = value;
  closeSuggestions();
  input.focus();
}

function navigateSuggestions(direction) {
  const items = suggestions.querySelectorAll('.suggestion');
  if (items.length === 0) return;
  items[activeIndex]?.setAttribute('aria-selected', 'false');
  if (direction === 'down') {
    activeIndex = (activeIndex + 1) % items.length;
  } else if (direction === 'up') {
    activeIndex = activeIndex <= 0 ? items.length - 1 : activeIndex - 1;
  }
  items[activeIndex].setAttribute('aria-selected', 'true');
  items[activeIndex].scrollIntoView({ block: 'nearest' });
  input.setAttribute('aria-activedescendant', items[activeIndex].id);
}

function showSpinner() { spinner.hidden = false; }
function hideSpinner() { spinner.hidden = true; }

input.addEventListener('input', (e) => {
  const value = e.target.value;
  clearBtn.hidden = !value;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => search(value), 300);
});

input.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    navigateSuggestions('down');
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    navigateSuggestions('up');
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const items = suggestions.querySelectorAll('.suggestion');
    if (activeIndex >= 0 && items[activeIndex]) {
      selectSuggestion(items[activeIndex].textContent);
    }
  } else if (e.key === 'Escape') {
    closeSuggestions();
  }
});

clearBtn.addEventListener('click', () => {
  input.value = '';
  clearBtn.hidden = true;
  closeSuggestions();
  input.focus();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-autocomplete')) {
    closeSuggestions();
  }
});
  `}
/>

## 実装コード

**HTML**
```html
<div class="search-autocomplete">
  <div class="search-input-wrapper">
    <input
      type="text"
      id="search"
      class="search-input"
      placeholder="Search..."
      autocomplete="off"
      aria-autocomplete="list"
      aria-controls="suggestions"
      aria-expanded="false"
      role="combobox"
    />
    <button class="search-clear" aria-label="Clear search" hidden>×</button>
    <div class="search-spinner" hidden></div>
  </div>
  <ul
    id="suggestions"
    class="suggestions"
    role="listbox"
    hidden
  ></ul>
</div>
```

**CSS**
```css
.search-autocomplete { position: relative; max-width: 400px; }
.search-input-wrapper { position: relative; display: flex; align-items: center; }
.search-input {
  width: 100%;
  padding: .75rem 2.5rem .75rem 1rem;
  border: 2px solid #ccc;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color .2s;
}
.search-input:focus {
  outline: none;
  border-color: #0066cc;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}
.search-clear {
  position: absolute;
  right: 2.5rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #666;
  cursor: pointer;
  padding: .25rem;
  line-height: 1;
}
.search-clear:hover { color: #000; }
.search-spinner {
  position: absolute;
  right: .75rem;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #0066cc;
  border-radius: 50%;
  animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.suggestions {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
  max-height: 300px;
  overflow-y: auto;
  margin: 0;
  padding: 0;
  list-style: none;
  z-index: 100;
}
.suggestion {
  padding: .75rem 1rem;
  cursor: pointer;
  transition: background .15s;
}
.suggestion:hover { background: #f0f0f0; }
.suggestion[aria-selected="true"] { background: #e3f2fd; }
.suggestion mark {
  background: #ffeb3b;
  color: inherit;
  font-weight: 600;
  padding: 0;
}
.no-results {
  padding: 1rem;
  text-align: center;
  color: #666;
  font-style: italic;
}
```

**JS**
```js
(() => {
  const input = document.querySelector('.search-input');
  const clearBtn = document.querySelector('.search-clear');
  const spinner = document.querySelector('.search-spinner');
  const suggestions = document.getElementById('suggestions');
  if (!input || !suggestions) return;

  let debounceTimer;
  let activeIndex = -1;

  // Sample data (replace with API call)
  const data = [
    'JavaScript', 'TypeScript', 'Python', 'Java', 'Ruby',
    'React', 'Vue', 'Angular', 'Svelte', 'Next.js',
    'Node.js', 'Deno', 'Express', 'FastAPI', 'Django'
  ];

  async function search(query) {
    if (!query.trim()) {
      closeSuggestions();
      return;
    }

    showSpinner();
    // Simulate API delay
    await new Promise(res => setTimeout(res, 300));

    const results = data.filter(item =>
      item.toLowerCase().includes(query.toLowerCase())
    );

    hideSpinner();
    displaySuggestions(results, query);
  }

  function displaySuggestions(results, query) {
    suggestions.innerHTML = '';
    activeIndex = -1;

    if (results.length === 0) {
      suggestions.innerHTML = '<li class="no-results">No results found</li>';
      openSuggestions();
      return;
    }

    results.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = 'suggestion';
      li.setAttribute('role', 'option');
      li.setAttribute('id', `suggestion-${idx}`);
      li.setAttribute('aria-selected', 'false');

      // Highlight matching text
      const regex = new RegExp(`(${query})`, 'gi');
      li.innerHTML = item.replace(regex, '<mark>$1</mark>');

      li.addEventListener('click', () => selectSuggestion(item));
      suggestions.appendChild(li);
    });

    openSuggestions();
  }

  function openSuggestions() {
    suggestions.hidden = false;
    input.setAttribute('aria-expanded', 'true');
  }

  function closeSuggestions() {
    suggestions.hidden = true;
    input.setAttribute('aria-expanded', 'false');
    activeIndex = -1;
    input.removeAttribute('aria-activedescendant');
  }

  function selectSuggestion(value) {
    input.value = value;
    closeSuggestions();
    input.focus();
  }

  function navigateSuggestions(direction) {
    const items = suggestions.querySelectorAll('.suggestion');
    if (items.length === 0) return;

    items[activeIndex]?.setAttribute('aria-selected', 'false');

    if (direction === 'down') {
      activeIndex = (activeIndex + 1) % items.length;
    } else if (direction === 'up') {
      activeIndex = activeIndex <= 0 ? items.length - 1 : activeIndex - 1;
    }

    items[activeIndex].setAttribute('aria-selected', 'true');
    items[activeIndex].scrollIntoView({ block: 'nearest' });
    input.setAttribute('aria-activedescendant', items[activeIndex].id);
  }

  function showSpinner() {
    spinner.hidden = false;
  }

  function hideSpinner() {
    spinner.hidden = true;
  }

  // Event listeners
  input.addEventListener('input', (e) => {
    const value = e.target.value;
    clearBtn.hidden = !value;

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => search(value), 300);
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      navigateSuggestions('down');
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      navigateSuggestions('up');
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const items = suggestions.querySelectorAll('.suggestion');
      if (activeIndex >= 0 && items[activeIndex]) {
        selectSuggestion(items[activeIndex].textContent);
      }
    } else if (e.key === 'Escape') {
      closeSuggestions();
    }
  });

  clearBtn.addEventListener('click', () => {
    input.value = '';
    clearBtn.hidden = true;
    closeSuggestions();
    input.focus();
  });

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-autocomplete')) {
      closeSuggestions();
    }
  });
})();
```
